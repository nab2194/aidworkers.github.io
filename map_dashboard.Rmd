---
title: "Aid Worker Attacks"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    source_code: embed
runtime: shiny
---

```{r setup}
library(tidyverse)
library(dplyr)
library(leaflet)
library(lubridate)
library(rvest)
library(httr)
library(flexdashboard)
library(plotly)
library(viridis)
library(stringr)
library(rworldmap)
knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)
theme_set(theme_minimal() + theme(legend.position = "bottom"))
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

## Data import and tidying

```{r scraping_aidworker_data_and_tidying}
url = "https://aidworkersecurity.org/incidents/search"
aidworker_html = read_html(url)

aidworker_df = 
  aidworker_html %>% 
  html_nodes(css = "table") %>%  
  first() %>% 
  html_table() %>% 
  as_tibble()

aidworker_df =
  aidworker_df %>%
  janitor::clean_names() %>% 
  select(-source, -verified) %>% 
  rename(year = year_sort_descending) %>% 
  mutate(intl_org_affected = 
           case_when(
             un != 0 ~ "yes",
             ingo != 0 ~ "yes",
             icrc != 0 ~ "yes",
             ifrc != 0 ~ "yes",
             other != 0 ~ "yes",
             lngo_and_nrcs != 0 ~ "no"),
         intl_org_affected = as.factor(intl_org_affected)) %>% 
  mutate(
    latitude = as.numeric(latitude),
    longitude = as.numeric(longitude)
    ) %>% 
  relocate(id, month, day, year, country, intl_org_affected)

empty_as_na <- function(x){
    if("factor" %in% class(x)) x <- as.character(x) 
    ifelse(as.character(x) != "", x, NA)
}

aidworker_df = 
aidworker_df %>% mutate_each(funs(empty_as_na)) 

```

```{r global_map_df}
global_map_df = 
  aidworker_df %>% 
  mutate(
    kidnapping = case_when(means_of_attack %in% c("Kidnapping", "Kidnap-killing") ~ 1),
    shooting = case_when(means_of_attack %in% c("Shooting") ~ 1),
    assault = case_when(means_of_attack %in% c("Bodily assault", "Rape/sexual assault") ~ 1),
    explosive = case_when(means_of_attack %in% c("Aerial bombardment", "Landmine", "Other Explosives", "Roadside IED",
                                                 "Shelling", "Vehicle-born IED") ~ 1)) %>% 
  drop_na(year) %>% 
  group_by(country, year) %>% 
  summarize(tot_national = sum(total_national_staff),
            tot_intl = sum(total_international_staff),
            tot_victims = sum(total_victims),
            tot_kidnappings = sum(kidnapping, na.rm = TRUE),
            tot_shootings = sum(shooting, na.rm = TRUE),
            tot_assault = sum(assault, na.rm = TRUE),
            tot_explosive = sum(explosive, na.rm = TRUE)) %>% 
  drop_na(country)
```

Hey team - so I found a pacakge called `rworldmap`. You can access useful information about how to use the package by calling `vignette("rworldmap")`.

```{r explore_rworldmap_package}
global_map_df %>% 
joinCountryData2Map(
  joinCode = "NAME",
  nameJoinColumn = "country",
  verbose = TRUE
  )
```

So, Chechnya, DR Congo, Kashmir, Libyan Arab Jamahiriya, Occupied Palestinian Territories are in our df, but not in the map. As per the reasons outlined in part_1.RMD, I think we should drop Kashmir (only 1 incident) and recode Chechnya as Russia (we have no other data in Russia), and make a note. We could try recoding the other countries with other names for them and see if they end up matching up.

```{r}
joined_map = 
  global_map_df %>%
  filter(year == "2019") %>% 
joinCountryData2Map(
  joinCode = "NAME",
  nameJoinColumn = "country",
  verbose = TRUE
  )

par(mai =c (0,0,0.2,0), xaxs = "i", yaxs = "i")
glob_map = mapCountryData(joined_map, nameColumnToPlot = "tot_victims", addLegend = FALSE)

```

It worked!!!! I think? Can filter by year. Concerned that the documentation specifies that the df that should be merged to the map should only have one country per line. Also, we're missing important countries that didn't exist on the underlying map (Palestine, Libya, DR Congo). I think we need to find out how they're stored in the underlying map so that we can recode the country names in our df before merging.

```{r unmatched_countries}
joined_map$country %>% 
  view()

view(countrySynonyms)

global_map_df$country =
  recode(global_map_df$country,
         'Chechnya' = 'Russia',
         'DR Congo' = 'Democratic Republic of the Congo',
         'Syria' = 'Syrian Arab Republic',
         'Libyan Arab Jamahiriya' = 'Libya',
         'Occupied Palestinian Territories' = 'Occupied Palestinian Territory')

global_map_df =
  global_map_df %>% 
  filter(country != "Kashmir")

```

First I tried to view the list of countries once merged. It appears to only show the countries from our DF.

Then I found that the `rworldmap` package has a df with a list of synonyms for the countries it includes. I pulled up the df and searched for the five countries that did not match, to see how they are referred to by the `rworldmap` package. 

Now I'm going to go back and try merging with the new df with tidied / matched names. I ran the code and found 0 failed codes. Yay! We've matched. Next steps involve confirming that we can match multiple rows of data with the same country.


Aid Worker Attack Map
===================================== 

Column {.sidebar}
-----------------------------------------------------------------------

```{r sidebar}


```


Column {.tabset}
-----------------------------------------------------------------------

### GLOBAL MAP

```{r global_map}
