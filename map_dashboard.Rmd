---
title: "Aid Worker Attacks"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    source_code: embed
runtime: shiny
---

```{r setup}
library(tidyverse)
library(dplyr)
library(leaflet)
library(lubridate)
library(rvest)
library(httr)
library(flexdashboard)
library(plotly)
library(viridis)
library(stringr)
library(rworldmap)
knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)
theme_set(theme_minimal() + theme(legend.position = "bottom"))
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

## Data import and tidying

```{r scraping_aidworker_data_and_tidying}
url = "https://aidworkersecurity.org/incidents/search"
aidworker_html = read_html(url)

aidworker_df = 
  aidworker_html %>% 
  html_nodes(css = "table") %>%  
  first() %>% 
  html_table() %>% 
  as_tibble()

aidworker_df =
  aidworker_df %>%
  janitor::clean_names() %>% 
  select(-source, -verified) %>% 
  rename(year = year_sort_descending) %>% 
  mutate(intl_org_affected = 
           case_when(
             un != 0 ~ "yes",
             ingo != 0 ~ "yes",
             icrc != 0 ~ "yes",
             ifrc != 0 ~ "yes",
             other != 0 ~ "yes",
             lngo_and_nrcs != 0 ~ "no"),
         intl_org_affected = as.factor(intl_org_affected)) %>% 
  mutate(
    latitude = as.numeric(latitude),
    longitude = as.numeric(longitude)
    ) %>% 
  relocate(id, month, day, year, country, intl_org_affected)

empty_as_na <- function(x){
    if("factor" %in% class(x)) x <- as.character(x) 
    ifelse(as.character(x) != "", x, NA)
}

aidworker_df = 
aidworker_df %>% mutate_each(funs(empty_as_na)) 

```

```{r global_map_df}
global_map_df = 
  aidworker_df %>% 
  mutate(
    kidnapping = case_when(means_of_attack %in% c("Kidnapping", "Kidnap-killing") ~ 1),
    shooting = case_when(means_of_attack %in% c("Shooting") ~ 1),
    assault = case_when(means_of_attack %in% c("Bodily assault", "Rape/sexual assault") ~ 1),
    explosive = case_when(means_of_attack %in% c("Aerial bombardment", "Landmine", "Other Explosives", "Roadside IED",
                                                 "Shelling", "Vehicle-born IED") ~ 1)) %>% 
  drop_na(year) %>% 
  group_by(country, year) %>% 
  summarize(
            number_incidents = n(),
            tot_national = sum(total_national_staff),
            tot_intl = sum(total_international_staff),
            tot_victims = sum(total_victims),
            tot_kidnappings = sum(kidnapping, na.rm = TRUE),
            tot_shootings = sum(shooting, na.rm = TRUE),
            tot_assault = sum(assault, na.rm = TRUE),
            tot_explosive = sum(explosive, na.rm = TRUE)) %>% 
  drop_na(country)

global_map_df$country =
  recode(global_map_df$country,
         'Central African Republic' = 'Central African Rep.',
         'Republic of Congo' = 'Congo',
         'Cote D\'Ivoire' = 'CÃ´te d\'Ivoire',
         'Democratic Republic of the Congo' = 'Dem. Rep. Congo',
         'Occupied Palestinian Territory' = 'Palestine',
         'South Sudan' = 'S. Sudan',
         'Syrian Arab Republic' = 'Syria',
         'Western Sahara' = 'W. Sahara'
         )

global_map_df =
  global_map_df %>% 
  filter(country != "Mauritius")

global_map_df =
  global_map_df %>% 
  rename(name = country)
```


```{r read_polygons}
countries = geojsonio::geojson_read("./data/custom.geo.json", what = "sp")

df_2019 =
  global_map_df %>% 
  filter(year == "2019")

joined_map_2019 = sp::merge(countries, df_2019)

bins = c(0, 10, 20, 50, 100, 200)
pal = colorBin("YlOrRd", domain = joined_map_2019$tot_victims, bins = bins)

labels = glue::glue("<strong>{joined_map_2019$name}</strong><br/>{joined_map_2019$number_incidents} total incidents<br/>{joined_map_2019$tot_victims} victims<br/>{joined_map_2019$tot_national} national victims<br/>{joined_map_2019$tot_intl} international victims") %>%
  purrr::map(htmltools::HTML)

main_map = leaflet(joined_map_2019) %>% 
  addTiles() %>% 
  addPolygons(
    fillColor = ~pal(tot_victims),
    weight = 2,
    opacity = 1,
    color = "black",
    dashArray = "1",
    fillOpacity = 0.5,
    highlight = highlightOptions(
      weight = 5,
      color = "#666",
      dashArray = "",
      fillOpacity = 0.7,
      bringToFront = TRUE),
    label = labels,
    labelOptions = labelOptions(
      style = list("font-weight" = "normal", padding = "3px 8px"),
      textsize = "15px",
      direction = "auto")) %>%
  addLegend(pal = pal, values = ~tot_victims, opacity = 0.7, title = NULL,
    position = "bottomright"
    )

main_map
```

Mauritius was dropped. Only 1 attack. Make note in final dashboard.

Next steps:
* write function to match df (for each YEAR) with polygons - this is what will be called in the shiny app
* popups for hovering over each country - way to work with html to show more info like a drop down? don't want too much in the pop-ups
* shiny!

Aid Worker Attack Map
===================================== 

Column {.sidebar}
-----------------------------------------------------------------------

```{r sidebar}


```


Column {.tabset}
-----------------------------------------------------------------------

### GLOBAL MAP

```{r global_map}

