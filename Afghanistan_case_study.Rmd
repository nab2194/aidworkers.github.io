---
title: "Afghanistan Case Study" 
output: github_document
---

```{r setup and data visualization preferences}
library(tidyverse)
library(readxl)
library(p8105.datasets)
library(hexbin)
library(patchwork)
library(leaflet)
library(lubridate)
library(xml2)
library(rvest)
library(plotly)

devtools::install_github("benmarwick/wordcountaddin",  type = "source", dependencies = TRUE)
knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)
theme_set(theme_minimal() + theme(legend.position = "bottom"))
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

##Explain 

Why we chose Afghanistan... 
Which datasets are being used... 

Using the years 2008-2016 because.... and supply code 

Aidworker dataset - cleaning and tailoring

```{r basic cleaning and exploring}
#Kailey notes: from section 1 cleaning and filtered for afghanistan/year

url = "https://aidworkersecurity.org/incidents/search"
aidworker_html = read_html(url)

aidworker_df = 
  aidworker_html %>% 
  html_nodes(css = "table") %>%  
  first() %>% 
  html_table() %>% 
  as_tibble()

afghan_aidworker_df =
  aidworker_df %>%
  janitor::clean_names() %>% 
  select(-source, -verified) %>% 
  rename(year = year_sort_descending) %>% 
  mutate(intl_org_affected = 
           case_when(
             un != 0 ~ "yes",
             ingo != 0 ~ "yes",
             icrc != 0 ~ "yes",
             ifrc != 0 ~ "yes",
             other != 0 ~ "yes",
             lngo_and_nrcs != 0 ~ "no"),
         intl_org_affected = as.factor(intl_org_affected)) %>% 
  relocate(id, month, day, year, country, intl_org_affected) %>% 
  filter(country == "Afghanistan") %>% 
  filter(year %in% c("2008", "2009", "2010", "2011", "2012", "2013", "2014", "2015", "2016")) 

## Alisha: This all works for me and looks great
```


## Kailey notes: I found it! This pivot longer is making the duplicates occur when added to the code chunk above.. also, this date code is not working for me! 

afghan_aidworker_df %>% 
  pivot_longer(
  un:other,
    names_to = "org_type", 
    values_to = "number_orgs_affected"
  ) %>% 
  select(-number_orgs_affected)

```{r}

afghan_aidworker_df_new =
  afghan_aidworker_df%>% 
  mutate(month = as.numeric(month),
         day = as.numeric(day),
         year = as.numeric(year)) %>% view()

afghan_aidworker_df_new$date = as.Date(paste(afghan_aidworker_df_new$year, afghan_aidworker_df$month, afghan_aidworker_df_new$day, sep = "-"), "%Y-%m-%d") 

```

pivot_longer(
  un:other,
    names_to = "org_type", 
    values_to = "number_orgs_affected"
  ) %>% 
  select(-number_orgs_affected)

aidworker_df$date <- as.Date(with(afghan_aidworker_df, paste(year, month, day, sep = "-")), "%Y-%m-%d")

## Starting EDA and vis

Internationals vs. nationals killed (Not in the to-do list but has an interesting spikes and dips; check historical context?)

```{r}
#Kailey notes: FINALLY figured this out. got rid of all duplicates and strange number counts.
#Alisha notes: can't get these first few lines of code to run (117-121) so I'm just leaving them out for now...? Are they necessary?

# take code from international (part 1 dataset) - just copy paste and add a filter(country == "Afghanistan")

#afghan_aidw_international_df = 
#  aidworker_df %>%
#  filter(Country == "Afghanistan") %>% 
#  filter(year %in% c("2008", "2009", "2010", "2011", "2012", "2013", "2014", "2015", "2016"))


afghan_aidworker_international_df =
  afghan_aidworker_df %>% 
  group_by(year) %>% 
  summarise(sum(internationals_killed)) %>% 
  mutate(
    internationals_killed_tot = `sum(internationals_killed)`
  ) %>% 
  select(year, internationals_killed_tot)

afghan_aidworker_national_df = 
  afghan_aidworker_df %>% 
  group_by(year) %>%
  count(nationals_killed) %>% 
  mutate(
    nationals_killed_tot = n
  ) 

afghan_aidw_df_new = 
  left_join(afghan_aidworker_international_df, afghan_aidworker_national_df, by = "year") %>% 
  select(year, internationals_killed_tot, nationals_killed_tot) %>% 
  group_by(year) %>% view()
  mutate(
    yearly_internationals_killed = sum(internationals_killed_tot),
    yearly_nationals_killed = sum(nationals_killed_tot)) %>% 
  select(year, yearly_internationals_killed, yearly_nationals_killed) %>% 
  slice(1, 16, 28, 40, 50, 54, 68, 86, 93)
  
  summarise(sum(nationals_killed)) %>% 
  mutate(
    nationals_killed_tot = `sum(nationals_killed)`
  ) %>% 
  select(year, nationals_killed_tot)


afghan_aidworker_df_new = 
  left_join(afghan_aidworker_international_df, afghan_aidworker_national_df, by = "year") 


afghan_aidworker_df_new %>% 
     ggplot(aes(x = year, y = internationals_killed_tot, col = "International")) +
   geom_line() +
  geom_line(aes(x = year, y = nationals_killed_tot, col = "National")) +
  labs(
    title = "Number of Aidworkers Killed By Origin (National vs. International)",
    x = "Year",
    y = "Number Killed"
  ) 

# Alisha note: so when I run this I'm still getting multiples for some of the datapoints that I can't make sense of right now
```

More visualizations using aidworker df 

```{r}
# Kailey notes: Not sure if this visualization is 100% complete in terms of making sense/usefulness but I think something like this could be interesting. Subplotted two interactive plots. You can see the means of attack next to the attack context. For example, the aerial bombardment spike in 2015 is tied to combat/crossfire attack type (could look at historical context here). Can also see that in 2009 there were 16 kidnappings due to an ambush. Open to thoughts on this but thought something like this could be cool. 

# Alisha notes: This is great, thank you so much for making this. 


means_attack_p = 
afghan_aidworker_df %>%
  plot_ly(
    x = ~year, y = ~total_victims, color = ~means_of_attack, 
    type = "scatter") %>% 
    layout(
    title = "Victims per year by attack type")

attack_context_p =
afghan_aidworker_df %>%
  plot_ly(
    x = ~year, y = ~total_victims, color = ~attack_context, 
    type = "scatter") %>%
    layout(
    title = "Victims per year by attack context")

subplot(means_attack_p, attack_context_p)

```


```{r}
afghan_aidworker_df %>% 
     ggplot(aes(x = location, fill = means_of_attack)) +
   geom_bar() +
  labs(
    title = "Attacks per location and by what means of attack",
    x = "Location"
  ) 

# Alisha notes: love this graph! We'll want to define the time period as well which I'll figure out ASAP. 
```

From section 1 vis: 

looking at frequency of attacks on staff of various organizations yes/no

```{r}
afghan_aidworker_df %>% 
  ggplot(aes(x = intl_org_affected)) + 
  geom_bar()
```

International vs National staff attacks?

```{r}
af_pct_intl_ntl = 
afghan_aidworker_df %>%
  group_by(year) %>% 
  summarize(tot_national = sum(total_national_staff),
            tot_intl = sum(total_international_staff),
            tot_both = sum(total_victims),
            pct_intl = (tot_intl/tot_both)*100,
            pct_national = (tot_national/tot_both)*100) %>% 
  ggplot(aes(x = year, y = pct_national, col = 3)) + 
  geom_line() +
   geom_line(aes(x = year, y = pct_intl, col = 2)) + 
   labs(
    x = "Year",
    y = "% Attacked"
   )

## Would still need to add labels for understanding
```

## Kailey notes: need to scrape uppsala data from web instead of loading in by .csv

# Filter Uppsala dataset for just Afghanistan to examine overall violence overtime alongside violence against aidworkers 
# Deaths among all civilians vs. all aidworkers side by side
-- are these different questions? 

Uppsala data upload and cleaning/tailoring (downloaded data for Afghanistan only)

```{r}
#Looking at deaths among all civilians verses all aidworkers side by side

#Aidworkers: 
aidworker_deaths_p = 
afghan_aidworker_df %>% 
  group_by(year) %>% 
  summarise(sum(total_victims)) %>%
  mutate(
    tot_victims = `sum(total_victims)`
  ) %>% 
  select(-`sum(total_victims)`) %>% 
  ggplot(aes(x = year, y = tot_victims, col = "Aidworkers")) +
   geom_line() +
  labs(
    title = "Total # of Aidworkers Killed per year",
    x = "Year",
    y = "Number Killed"
  ) 

#All civilians:
afghan_upp_df = 
read_csv("./data/afghanistan_uppsala.csv") %>%
  janitor::clean_names() %>% 
  filter(year %in% c("2008", "2009", "2010", "2011", "2012", "2013", "2014", "2015", "2016")) %>% 
  select(year, deaths_civilians) %>% 
  group_by(year) %>% 
  summarise(sum(deaths_civilians)) %>% 
  mutate(
    deaths_civilians_tot = `sum(deaths_civilians)`
  ) %>% 
  select(-`sum(deaths_civilians)`)

civilian_deaths_p =
afghan_upp_df %>% 
  ggplot(aes(x = year, y = deaths_civilians_tot, col = "Civilian")) +
   geom_line() +
  labs(
<<<<<<< HEAD
    title = "Aidworkers and Civilians Killed",
    x = "Year",
    y = "Number Killed"
  ) 
# use patchwork to make two separate plots and have them side-by-side
=======
    title = "Total # of Civilians Killed per year",
    x = "Year",
    y = "Number Killed"
  ) 

aidworker_deaths_p + civilian_deaths_p

#Kailey notes: Total victims = all aidworkers killed, right? Do these make sense to go side by side or is there no 'side by side' analysis here? 
>>>>>>> f508b2456d482820cb90337375df1b2c6e5c5ef3
```

# Kailey notes: Are we using SHCC or complete scrap? 

#SHCC Afghanistan dataset (need to bring in multiple years) 

```{r}
shcc2018_df = 
  read_excel("data/2018-shcc-attacks-data.xlsx", skip = 1) %>% 
  janitor::clean_names() %>% 
  rename_at(vars(matches("number_")), ~ str_remove(., "number_")) %>% 
  filter(country_name == "Afghanistan") %>% 
    mutate(tot_hc_workers_affected = 
           affected_healthworker_killed + 
           affected_healthworker_sgbv + 
           affected_healthworker_arrested + 
           affected_healthworker_injured + 
           affected_healthworker_kidnapped) %>% 
  mutate(tot_hc_facilities_affected = 
           impact_health_facility_num +
           event_health_facility_destroyed_num +
           event_health_facility_damaged_num +
           impact_health_facility_armed_entry_num +
           impact_health_supplies_taken_num +
           impact_health_facility_occupation_num
           ) %>% 
  mutate(tot_hc_transport_affected = 
          impact_health_transport_destroyed_num + 
           impact_health_transport_damaged_num +
           impact_health_transport_abducted_num) 

# these columns are just straight up full of N/As...........
shcc2018_df %>% 
  ggplot(aes(x = date_occurrence, y = affected_healthworker_killed)) +
   geom_line() +
  geom_line(data = shcc2018_df, aes(x = date_occurrence, y = event_health_facility_destroyed_num)) +
  labs(
    title = "Aidowrkers and HCFs Destroyed",
    x = "Date",
    y = "Number Killed"
  ) 

# If we want to do a bar graph comparing total HCWs affected vs. total healthcare facilities affected in 2018 and 2019? Something is very off here.......


shcc2019_df = 
  read_excel("data/2019-shcc-healthcare-afghanistan-data.xlsx", skip = 1) %>% 
  janitor::clean_names() %>%
  rename_at(vars(matches("number_")), ~ str_remove(., "number_")) %>% 
  filter(country_name == "Afghanistan") %>% 
  select(-"x12") %>%
  mutate(
    tot_hc_worker_affected = 
      affected_healthworker_killed + 
      affected_healthworker_kidnapped +
      affected_healthworker_threatened + 
      affected_healthworker_injured + 
      affected_healthworker_assaulted + 
      affected_healthworker_sgbv
    ) %>% 
  mutate(
      tot_hc_facilities_affected = 
        indicator_health_facility_destroyed_num +
        indicator_health_facility_damaged_num + 
        indicator_health_facility_armed_entry_num +
        indicator_health_supplies_taken_num
    ) %>% 
  mutate(
       tot_hc_transport_affected = 
         indicator_health_transport_destroyed_num +
         indicator_health_transport_damaged_num +
         indicator_health_transport_abducted_num
      )
```


# Discuss confounders (U.S. administration changes? Troop levels in country? Natural disastor?)