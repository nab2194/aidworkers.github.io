---
title: "Afghanistan Case Study" 
output: github_document
always_allow_html: true
---

```{r setup and data visualization preferences}
library(tidyverse)
library(readxl)
library(p8105.datasets)
library(hexbin)
library(patchwork)
library(leaflet)
library(lubridate)
library(xml2)
library(rvest)
library(plotly)

devtools::install_github("benmarwick/wordcountaddin",  type = "source", dependencies = TRUE)
knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)
theme_set(theme_minimal() + theme(legend.position = "bottom"))
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

##Explain 

We chose to focus on Afghanistan because it has consistently been among the most deadly countries for aid workers, so we expected fairly robust data. Further, Afghanistan especially has been heavily affected by American occupation, which has changed dramatically between presidential administrations. 

Which datasets are being used... 
We are using the aid worker dataset and the Uppsala datset to compare aidworker deaths to Civilian deaths. We also intended to use a dataset (SHCC) describing attacks on aidworkers, health facilities, and healthcare transport, but this dataset was not robust enough to support meaningful data visualization. As such, we chose to exclude it.

Using the years 2008-2016 because.... and supply code 
2008-2016 chosen to see whether there might be differences between the Bush (2008-2012) and Obama (2012-2016) administrations. 

Aidworker dataset - cleaning and tailoring

```{r basic cleaning and exploring}
#Kailey notes: from section 1 cleaning and filtered for afghanistan/year

url = "https://aidworkersecurity.org/incidents/search"
aidworker_html = read_html(url)

aidworker_df = 
  aidworker_html %>% 
  html_nodes(css = "table") %>%  
  first() %>% 
  html_table() %>% 
  as_tibble()

afghan_aidworker_df =
  aidworker_df %>%
  janitor::clean_names() %>% 
  select(-source, -verified) %>% 
  rename(year = year_sort_descending) %>% 
  mutate(intl_org_affected = 
           case_when(
             un != 0 ~ "yes",
             ingo != 0 ~ "yes",
             icrc != 0 ~ "yes",
             ifrc != 0 ~ "yes",
             other != 0 ~ "yes",
             lngo_and_nrcs != 0 ~ "no"),
         intl_org_affected = as.factor(intl_org_affected)) %>% 
  relocate(id, month, day, year, country, intl_org_affected) %>% 
  filter(country == "Afghanistan") %>% 
  filter(year %in% c("2008", "2009", "2010", "2011", "2012", "2013", "2014", "2015", "2016")) 

```


## Starting EDA and vis

Internationals vs. nationals killed (Not in the to-do list but has an interesting spikes and dips; check historical context?)

```{r}
afghan_aidworker_international_df =
  afghan_aidworker_df %>% 
  group_by(year) %>% 
  summarise(sum(internationals_killed)) %>%
  mutate(
    internationals_killed_tot = `sum(internationals_killed)`
  ) %>%
  select(year, internationals_killed_tot) 

afghan_aidworker_national_df =
  afghan_aidworker_df %>%
  group_by(year) %>%
  summarise(sum(nationals_killed)) %>%
  mutate(
    nationals_killed_tot = `sum(nationals_killed)`
  ) %>%
  select(year, nationals_killed_tot) 

afghan_aidworker_df_new =
  left_join(afghan_aidworker_international_df, afghan_aidworker_national_df, by = "year")


afghan_aidworker_df_new %>%
     ggplot(aes(x = year, y = internationals_killed_tot, col = "International")) +
   geom_line() +
  geom_line(aes(x = year, y = nationals_killed_tot, col = "National")) +
  labs(
    title = "Number of Aid Workers Killed By Origin (National vs. International)",
    x = "Year",
    y = "Number Killed"
  )

```

*2012* - The drop in aid worker death is correlated with the withdrawal of half of American troops in Afghanistan. 

*2013* - A sharp increase in aid worker deaths, primarily in rural areas. In 2013, aid workers were frequently caught in crossfire, ambush, and accidents. As you can see in this figure, a majority of aid workers killed are of national origin. According to a report published by the UN in 2013, "Afghan aid workers suffered heavy casualties in part because international organizations were using local staff and local organizations to reduce their own risk...About 85 per cent of United Nations staff involved in security incidents were Afghans; for international non-governmental organizations, it was 76 per cent.  Security arrangements of those organizations and the United Nations often left local humanitarian organizations less secure." Local aid workers rarely received the same security protections as their international colleagues, forcing them into increasingly unsafe situations. After noting this sharp increase in attacks against local aid workers, many aid organizations took steps to decrease apparent distinctions between international and national aid workers in an effort to protect national aid workers' security.





More visualizations using aidworker df 

```{r}
means_attack_p =
afghan_aidworker_df %>%
  plot_ly(
    x = ~year, y = ~total_victims, color = ~means_of_attack,
    type = "scatter") %>%
    layout(
    title = "Victims per year by attack type")

attack_context_p =
afghan_aidworker_df %>%
  plot_ly(
    x = ~year, y = ~total_victims, color = ~attack_context,
    type = "scatter") %>%
    layout(
    title = "Victims per Year by Attack Context")

subplot(means_attack_p, attack_context_p)

```

Of known attack types affecting aid workers in Afghanistan, the most common are kidnappings, shootings, ambushes, and raids. The largest attack was a 2015 aerial bombardment by the U.S. military, in which aid workers were caught in combat/crossfire that left 19 dead and 37 wounded (including patients and aid workers).

On October 3rd, 2015, following Taliban insurgents storming the capital, the U.S. military conducted a 4-hour airstrike that 
hit a hospital run by Médecins Sans Frontières (MSF, Doctors Without Borders), destroying the main hospital building. Patients unable to escape burned to death, while hospital staff scrambled to evacuate as many patients as possible. 

Kunduz was the Taliban's last stronghold before being driven out by NATO. 

```{r}
afghan_aidworker_df %>% 
     ggplot(aes(x = location, fill = means_of_attack)) +
   geom_bar() +
  labs(
    title = "Total Attacks per Location, by Means of Attack (2008-2016)",
    x = "Location",
    y = "Number of Attacks"
  ) 

```

From section 1 vis: 

looking at frequency of attacks on staff of various organizations yes/no

```{r}
afghan_aidworker_df %>% 
  ggplot(aes(x = intl_org_affected)) + 
  geom_bar(color = "blue", fill = "#FFE4E4") +
  labs(
    title = "Distribution of Attacks by Organization Affected (2008-2016)",
    x = "International Organization Affected",
    y = "Number of Attacks"
  )
```

International vs National staff attacks

```{r}
af_pct_intl_ntl =
afghan_aidworker_df %>%
  group_by(year) %>%
  summarize(tot_national = sum(total_national_staff),
            tot_intl = sum(total_international_staff),
            tot_both = sum(total_victims),
            pct_intl = (tot_intl/tot_both)*100,
            pct_national = (tot_national/tot_both)*100) %>%
  
  ggplot(aes(x = year, y = pct_national, col = 3)) +
  geom_line() +
   geom_line(aes(x = year, y = pct_intl, col = 2)) +
   labs(
    x = "Year",
    y = "% Attacked"
   ) 

```


Uppsala data upload and cleaning/tailoring (downloaded data for Afghanistan only)

```{r}
#Looking at deaths among all civilians verses all aidworkers side by side

#Aidworkers, from the Aidworker dataset: 
aidworker_deaths_p = 
afghan_aidworker_df %>% 
  group_by(year) %>% 
  summarise(sum(total_victims)) %>%
  mutate(
    tot_victims = `sum(total_victims)`
  ) %>% 
  select(-`sum(total_victims)`) %>% 
  ggplot(aes(x = year, y = tot_victims)) +
   geom_line(color = "red", size =2) +
  labs(
    title = "Total # Aid Workers Killed per Year",
    x = "Year",
    y = "Number Aid Workers Killed"
  ) 

#All civilians, from the Uppsala dataset:
afghan_upp_df = 
  read_csv("./data/afghanistan_uppsala.csv") %>%
  janitor::clean_names() %>% 
  filter(year %in% c("2008", "2009", "2010", "2011", "2012", "2013", "2014", "2015", "2016")) %>% 
  select(year, deaths_civilians) %>% 
  group_by(year) %>% 
  summarise(sum(deaths_civilians)) %>% 
  mutate(
    deaths_civilians_tot = `sum(deaths_civilians)`
  ) %>% 
  select(-`sum(deaths_civilians)`) 

civilian_deaths_p =
afghan_upp_df %>% 
  ggplot(aes(x = year, y = deaths_civilians_tot)) +
   geom_line(color = "blue", size =2) +
  labs(
    title = "Total # Civilians Killed per Year",
    x = "Year",
    y = "Number Civilians Killed"
)

# use patchwork to make two separate plots and have them side-by-side

aidworker_deaths_p + civilian_deaths_p


```





```{r exploration of SHCC, include=FALSE}
shcc2018_df = 
  read_excel("data/2018-shcc-attacks-data.xlsx", skip = 1) %>% 
  janitor::clean_names() %>% 
  rename_at(vars(matches("number_")), ~ str_remove(., "number_")) %>% 
  filter(country_name == "Afghanistan") %>% 
    mutate(tot_hc_workers_affected = 
           affected_healthworker_killed + 
           affected_healthworker_sgbv + 
           affected_healthworker_arrested + 
           affected_healthworker_injured + 
           affected_healthworker_kidnapped) %>% 
  mutate(tot_hc_facilities_affected = 
           impact_health_facility_num +
           event_health_facility_destroyed_num +
           event_health_facility_damaged_num +
           impact_health_facility_armed_entry_num +
           impact_health_supplies_taken_num +
           impact_health_facility_occupation_num
           ) %>% 
  mutate(tot_hc_transport_affected = 
          impact_health_transport_destroyed_num + 
           impact_health_transport_damaged_num +
           impact_health_transport_abducted_num) 

# these columns are just straight up full of N/As...........
shcc2018_df %>% 
  ggplot(aes(x = date_occurrence, y = affected_healthworker_killed)) +
   geom_line() +
  geom_line(data = shcc2018_df, aes(x = date_occurrence, y = event_health_facility_destroyed_num)) +
  labs(
    title = "Aidowrkers and HCFs Destroyed",
    x = "Date",
    y = "Number Killed"
  ) 

# If we want to do a bar graph comparing total HCWs affected vs. total healthcare facilities affected in 2018 and 2019? Something is very off here.......


shcc2019_df = 
  read_excel("data/2019-shcc-healthcare-afghanistan-data.xlsx", skip = 1) %>% 
  janitor::clean_names() %>%
  rename_at(vars(matches("number_")), ~ str_remove(., "number_")) %>% 
  filter(country_name == "Afghanistan") %>% 
  select(-"x12") %>%
  mutate(
    tot_hc_worker_affected = 
      affected_healthworker_killed + 
      affected_healthworker_kidnapped +
      affected_healthworker_threatened + 
      affected_healthworker_injured + 
      affected_healthworker_assaulted + 
      affected_healthworker_sgbv
    ) %>% 
  mutate(
      tot_hc_facilities_affected = 
        indicator_health_facility_destroyed_num +
        indicator_health_facility_damaged_num + 
        indicator_health_facility_armed_entry_num +
        indicator_health_supplies_taken_num
    ) %>% 
  mutate(
       tot_hc_transport_affected = 
         indicator_health_transport_destroyed_num +
         indicator_health_transport_damaged_num +
         indicator_health_transport_abducted_num
      )
```



# Discuss confounders (U.S. administration changes? Troop levels in country? Natural disastor?)