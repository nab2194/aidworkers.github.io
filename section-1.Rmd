---
title: "Section 1"
author: "Natalie Boychuk, E. Brennan Bollman, Emily Bamforth, Alisha Sarakki, and Kailey Rishovd"
date: "11/26/2020"
output: github_document
---

This document is a working draft of section 1 of our final report, which will focus on global levels of violence against aid workers. 

```{r setup and data visualization preferences}
library(tidyverse)
library(dplyr)
library(patchwork)
library(leaflet)
library(lubridate)
library(rvest)
library(httr)
library(flexdashboard)
library(plotly)
library(viridis)
library(stringr)
devtools::install_github("benmarwick/wordcountaddin",  type = "source", dependencies = TRUE)
knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)
theme_set(theme_minimal() + theme(legend.position = "bottom"))
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

## Data import and tidying


```{r scraping aidworker data and basic tidying}
url = "https://aidworkersecurity.org/incidents/search"
aidworker_html = read_html(url)

aidworker_df = 
  aidworker_html %>% 
  html_nodes(css = "table") %>%  
  first() %>% 
  html_table() %>% 
  as_tibble()

aidworker_df =
  aidworker_df %>%
  janitor::clean_names() %>% 
  select(-source, -verified) %>% 
  rename(year = year_sort_descending) %>% 
  mutate(intl_org_affected = 
           case_when(
             un != 0 ~ "yes",
             ingo != 0 ~ "yes",
             icrc != 0 ~ "yes",
             ifrc != 0 ~ "yes",
             other != 0 ~ "yes",
             lngo_and_nrcs != 0 ~ "no"),
         intl_org_affected = as.factor(intl_org_affected)) %>% 
  mutate(
    latitude = as.numeric(latitude),
    longitude = as.numeric(longitude)
    ) %>% 
  relocate(id, month, day, year, country, intl_org_affected)

## This is a function that should turn strings with empty spaces into NA 
empty_as_na <- function(x){
    if("factor" %in% class(x)) x <- as.character(x) 
    ifelse(as.character(x)!="", x, NA)
}

aidworker_df = 
aidworker_df %>% mutate_each(funs(empty_as_na)) 

```

Brennan notes: 


* I think this `case_when` approach works to identify whether an international org was affected, instead of the pivot idea. Otherwise, I agree with Natalie that there's no way to do it without making 6 copies of each incident. The existing data already seems to be the clearest way to present the number of people from each type of org affected, and we can plot that.

* if happy with cleaning, we can rename the `aidworker_tidy_df` as just `aidworker_df`

Natalie notes: 

* distinct was left behind from when I was trying to get the pivot_longer working. Deleted now! 

* Realizing now that the year variable is sufficient for us! No need to mutate that :)


Emily notes:

* This looks great Brennan and Natalie! The `case_when` approach looks great for the org types for the reasons you outlined. I have an idea for the date variable, but what would we be using it for? Just wasn't sure which analysis requires it! Happy to take a stab at it though - let's discuss tomorrow?

* Can I remove gender variables from data frame? Don't believe we have a need for these for our analysis.
** Natalie: I wonder if they're worth keeping? We could see if male vs. female gender is predictive in the logistic regression model we'll run later. 

* We have many "unknown" values for actor type and name, and some blank countries, lat/long...in addition to NAs for some other variables. I think we may want to be consistent across the board and make all missing data NAs. Do you all agree? If so, I can address this.
** Natalie: I agree! 

## Most dangerous countries to be an aid worker

Natalie note: for some reason the rank wasn't working so I also tried sort but it wasn't working either, so if anyone has any ideas to trouble shoot that let me know!! 
```{r}
danger_countries = 
aidworker_df %>%
  group_by(country, na.rm = TRUE) %>% 
  summarize(tot_affected_per_country = sum(total_victims, na.rm = TRUE)) %>% 
  mutate(rank = sort(desc(tot_affected_per_country))) %>% 
  filter(rank < 6) %>% 
  knitr::kable()
```
```


### Look at frequency of attacks on staff of various types of organizations 

```{r}
aidworker_df %>% 
  ggplot(aes(x = intl_org_affected)) + 
  geom_bar()
```

Brennan: I'm stuck on this part. Natalie - you were thinking about it conceptually a lot, any ideas?

### International vs National staff attacks

```{r}
aidworker_df %>%
  group_by(year) %>% 
  summarize(tot_national = sum(total_national_staff),
            tot_intl = sum(total_international_staff),
            tot_both = sum(total_victims),
            pct_intl = (tot_intl/tot_both)*100,
            pct_national = (tot_national/tot_both)*100) %>%
  knitr::kable()

## If look at last row of data, appears "NA" is the total
## Natalie note: I'm only seeing NA in the year column, not anywhere else - looks like the sums worked fine. I think R just knows not to add up the years. 

## Plot of percentage of nationals affected by attacks over time 
pct_ntl =
aidworker_df %>%
  group_by(year) %>% 
  summarize(tot_national = sum(total_national_staff),
            tot_intl = sum(total_international_staff),
            tot_both = sum(total_victims),
            pct_intl = (tot_intl/tot_both)*100,
            pct_national = (tot_national/tot_both)*100) %>% 
  ggplot(aes(x = year, y = pct_national)) + 
  geom_line() +
    labs(
     x = "Year",
     y = "% National"
    )

## Plot of percentage of internationals affected by attacks over time 
pct_intl = 
aidworker_df %>%
  group_by(year) %>% 
  summarize(tot_national = sum(total_national_staff),
            tot_intl = sum(total_international_staff),
            tot_both = sum(total_victims),
            pct_intl = (tot_intl/tot_both)*100,
            pct_national = (tot_national/tot_both)*100) %>% 
  ggplot(aes(x = year, y = pct_intl)) + 
  geom_line() +
   labs(
    x = "Year",
    y = "% International"
   )

pct_ntl + pct_intl +
  plot_annotation(title = "Percent of Aid Workers Attacked Who Were National vs. International")

```

Roughly this shows that proportions of nationals attacked has always been higher than internationals, with increasing percentage of national staff attacked over time. 

```{r}
aidworker_df %>% 
  drop_na(year) %>% 
  group_by(year) %>% 
   summarize(tot_national = sum(total_national_staff),
            tot_intl = sum(total_international_staff),
            tot_both = sum(total_victims)) %>% 
  ggplot(aes(x = year)) + 
  geom_line(aes(y = tot_national, color = "National Staff")) + 
  geom_line(aes(y = tot_intl, color = "International Staff")) + 
  labs(title = "Aid Worker Attacks over time",
       x = "Year",
       y = "Number of Aid Workers Attacked")
```

Number of aid worker attacks are increasing over time, especially among national staff.

### Type of Attack

```{r}
kidnap_plot = 
aidworker_df %>% 
  filter(means_of_attack == "Kidnapping") %>% 
  group_by(year) %>% 
  summarize(tot_national = sum(total_national_staff),
            tot_intl = sum(total_international_staff),
            tot_both = sum(total_victims)) %>% 
  ggplot(aes(x = year)) + 
  geom_line(aes(y = tot_national, color = "National Staff")) + 
  geom_line(aes(y = tot_intl, color = "International Staff")) + 
  labs(title = "Aid Worker Kidnapping over time",
       x = "Year",
       y = "Number of Aid Workers Kidnapped")

shoot_plot = 
aidworker_df %>% 
  filter(means_of_attack == "Shooting") %>% 
  group_by(year) %>% 
  summarize(tot_national = sum(total_national_staff),
            tot_intl = sum(total_international_staff),
            tot_both = sum(total_victims)) %>% 
  ggplot(aes(x = year)) + 
  geom_line(aes(y = tot_national, color = "National Staff")) + 
  geom_line(aes(y = tot_intl, color = "International Staff")) + 
  labs(title = "Aid Worker Shooting over time",
       x = "Year",
       y = "Number of Aid Workers Shot")

```



Kidnapping also increasing over time, particularly among national staff. Could put this side-by-side the total attack line plot.

We can see that the same pattern is occurring with shootings among aid workers. There has been a sharp decrease in shootings among international staffers in the last 5-10 years. 


```{r}
aidworker_df %>% 
  filter(means_of_attack == "Unknown") %>% 
  group_by(year) %>% 
  summarize(tot_national = sum(total_national_staff),
            tot_intl = sum(total_international_staff),
            tot_both = sum(total_victims)) %>% 
  ggplot(aes(x = year)) + 
  geom_line(aes(y = tot_national, color = "National Staff")) + 
  geom_line(aes(y = tot_intl, color = "International Staff")) + 
  labs(title = "Aid Worker Attacks over time (unknown means)",
       x = "Year",
       y = "Number of Aid Workers Attacked via unknown means")
```

The above plot might explain part of the pattern we see above, as there is a gradual decrease in attacks of unknown means among national staff. This might be reflective of increases in reporting. 


```{r}
aidworker_df %>% 
  filter(means_of_attack == "Aerial bombardment") %>% 
  group_by(year) %>% 
  summarize(tot_national = sum(total_national_staff),
            tot_intl = sum(total_international_staff),
            tot_both = sum(total_victims)) %>% 
  ggplot(aes(x = year)) + 
  geom_line(aes(y = tot_national, color = "National Staff")) + 
  geom_line(aes(y = tot_intl, color = "International Staff")) + 
  labs(title = "Aid Worker Aerial Bombardment over time",
       x = "Year",
       y = "Number of Aid Workers Attacked via Aerial Bombardment")
```

Natalie: I think it would be cool to have a sort of dashboard of means of attack with the changes over time. I'm going to try to make this more interactive!!


#### Attempts to visualize type of attack over time - failed so far


```{r}
aidworker_df %>% 
  drop_na(year) %>% 
  group_by(year, means_of_attack) %>% 
  ggplot(aes(x = year, y = total_victims, color = means_of_attack)) + 
  geom_point()
```

Above is not good.

Note from Emily: What if we tried the following instead of the above, plotting by number of attacks, instead of by number of victims? Following plot still needs work (remove unknowns, any that we could combine?) but could be useful:

Note from Natalie: I like this, but I do think it's really informative to see the national/international differences. One option is making two plots and placing them side by side via patchwork! Or we could create an option on Shiny where people can click to see national vs. international vs. total.

```{r plot_attack_type_over_time}
aidworker_df %>% 
  drop_na(year) %>% 
  group_by(year) %>% 
    summarise(number_attack = n(), means_of_attack) %>% 
    as_tibble() %>% 
  group_by(means_of_attack) %>% 
  ggplot(aes(x = year, y = number_attack, color = means_of_attack)) + 
  geom_line() +
  labs(
    title = "Types of Attack Over Time",
    x = "Year",
    y = "Number of Attacks"
  )
```

```{r bar plot of types of attacks for both ntl and intl workers}
aidworker_df %>% 
  drop_na(year) %>% 
  group_by(year, means_of_attack) %>% 
  filter(year == 2019) %>% 
  ggplot(aes(x = means_of_attack, fill = means_of_attack)) + 
  geom_bar()
```


### Note from Natalie: I don't think we should use 2020 as our year of analysis if we limit ourselves to one year since the year isn't over and excluding the fall/winter might ignore seasonality effects 

I like this bar chart, but I think 'count' is the number of incidents, not the number of people affected. Would be really cool if this could be a shiny plot where could change year in a drop down to see how this changes over time? Or make a plotly so that you can hover over label to see number of intl/natl affected by each type of attack?

I'm not sure how to make those things work though. 

### Natalie: I'll give this a closer look tomorrow morning! 

```{r plot comparing attack type }

## This was a failed attempt at summarizing by worker type to see if there are differences in means of attack by international vs. national status 

#aidworker_df %>% 
  #select(id, year, total_national_staff, total_international_staff, means_of_attack) %>% 
  #as.numeric(c(total_international_staff, total_national_staff)) %>% 
  #group_by(means_of_attack) %>% 
  #summarize(across(total_national_staff:total_international_staff, count))

aidworker_df %>% 
  drop_na(year) %>% 
  group_by(year, means_of_attack) %>% 
  select(year, means_of_attack) %>% 
  filter(year == 2019) %>% 
  ggplot(aes(x = means_of_attack, fill = means_of_attack)) + 
  geom_bar()

```

# Mapping the data...

Attempt at `leaflet` map with points for attacks. When mapping all the data points, nothing appears on the map. Need to look into more. I've tried filtering to one or a handful of countries (this works), sampling the data (this sometimes works), clustering...

```{r attack_map}

attack_map =
  aidworker_df %>%
  drop_na(longitude, latitude) %>%
  leaflet() %>% 
  addProviderTiles(providers$CartoDB.Positron) %>% 
  addMarkers(
    lat = ~latitude,
    lng = ~longitude,
    clusterOptions = markerClusterOptions())
    
attack_map

```

Some of the things I tried included:

Mapping data for one country (or even multiple countries) by using `filter`. This will be useful for the Afghanistan case study. We can utilize the following code for the case study portion of the project. However, we have one outlier (in the Mediterranean) which shows up for Afghanistan - likely a data entry issue, which we should resolve. Needed to make a separate data frame with the filtered country data, in order to pull variables for the popups (otherwise it plots all 3000 points, but within the country you filtered by).


```{r afghanistan_map}

afghanistan_df =
  aidworker_df %>%
  drop_na(longitude, latitude) %>% 
  filter(country == "Afghanistan")
  
leaflet(afghanistan_df) %>% 
  addProviderTiles(providers$CartoDB.Positron) %>% 
  addMarkers(lat = ~latitude, lng = ~longitude,
  popup = paste("Total Victims:", afghanistan_df$total_victims, "<br>", "Means of Attack:", afghanistan_df$means_of_attack, "<br>", "Year:", afghanistan_df$year, "<br>", "Country:", afghanistan_df$country), clusterOptions = markerClusterOptions())
```

Tried using `slice_sample` to see how many points we could plot on the map. I got up to 1000, and then attempted 1100, which did not work, then going back down to 1000, then even 500, did not work anymore. I thought there could be an issue with plotting all 3000 points on the map, and maybe there was a point where the code would break. However, because it sometimes lets me pull 500, and sometimes 1000...something strange is going on here... The following code should pull a sample.

```{r samp_attack_map}

samp_attack_map =
  aidworker_df %>%
  drop_na(longitude, latitude) %>%
  slice_sample(n = 500) %>% 
  leaflet() %>% 
  addProviderTiles(providers$CartoDB.Positron) %>% 
  addMarkers(
    lat = ~latitude,
    lng = ~longitude,
    clusterOptions = markerClusterOptions())

samp_attack_map
```


Hey team, here's what happens if we map a random sample, but call values to include in the popups. I think this is happening because we're referring back to the unfiltered dataset when saying what to include in the popups. It's capable of plotting all 3000 observations...but it's plotting the incidents in the wrong countries!

```{r bad_example_map}
  aidworker_df %>%
  drop_na(longitude, latitude) %>%
  slice_sample(n = 500) %>% 
  leaflet() %>% 
  addProviderTiles(providers$CartoDB.Positron) %>% 
  addMarkers(
    lat = ~latitude,
    lng = ~longitude,
    popup = paste("Total Victims:", aidworker_df$total_victims, "<br>", "Means of Attack:", aidworker_df$means_of_attack, "<br>", "Year:", aidworker_df$year, "<br>", "Country:", aidworker_df$country),
    clusterOptions = markerClusterOptions())
```

Map in Shiny?
We want to map all of the global data, be able to filter by at least year, and include info on attack types, number of victims, national or international staff...

```{r}

```

